<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Database Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { margin-top: 50px; }
        .table-container { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 30px; }
        .table thead th { background-color: #007bff; color: white; border: none; }
        .table tbody tr:hover { background-color: #f1f3f4; }
        .table { border-radius: 10px; overflow: hidden; }
        h1 { color: #343a40; text-align: center; margin-bottom: 40px; }
        h2 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .no-data { color: #6c757d; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-4">Database Data</h1>
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#uploadToGitHubModal">Upload to GitHub</button>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Unpaid Debts Summary Card -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">Unpaid Debts Summary</h5>
            </div>
            <div class="card-body">
                {% if unpaid_summary %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Borrower Name</th>
                                    <th>Total Unpaid</th>
                                    <th>Lender Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for summary in unpaid_summary %}
                                    <tr class="clickable-row" data-borrower-id="{{ summary.borrower_id }}" data-lender-id="{{ summary.lender_id }}">
                                        <td>{{ summary.borrower_name }}</td>
                                        <td>${{ "%.2f"|format(summary.total_unpaid) }}</td>
                                        <td>{{ summary.lender_name }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-info view-all-btn" data-borrower-id="{{ summary.borrower_id }}" data-lender-id="{{ summary.lender_id }}" data-borrower-name="{{ summary.borrower_name }}" data-lender-name="{{ summary.lender_name }}">View All</button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No unpaid debts.</p>
                {% endif %}
            </div>
        </div>
        <ul class="nav nav-tabs" id="tableTabs" role="tablist">
            {% for table in tables %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if table == active_tab %}active{% endif %}" id="{{ table }}-tab" data-bs-toggle="tab" data-bs-target="#{{ table }}" type="button" role="tab" aria-controls="{{ table }}" aria-selected="{% if table == active_tab %}true{% else %}false{% endif %}">{{ table | title }}</button>
                </li>
            {% endfor %}
        </ul>
        <div class="tab-content" id="tableTabsContent">
            {% for table in tables %}
                <div class="tab-pane fade {% if table == active_tab %}show active{% endif %}" id="{{ table }}" role="tabpanel" aria-labelledby="{{ table }}-tab">
                    <div class="table-container">
                        {% if table == 'person' %}
                            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addPersonModal">Add Person</button>
                        {% elif table == 'debt' %}
                            <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addDebtModal">Add Debt</button>
                            <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#splitDebtModal">Split Debt</button>
                        {% endif %}
                        {% if all_data[table] and all_data[table] is not mapping %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            {% for col in all_data[table][0].keys() %}
                                                <th>{{ col | replace('_', ' ') | title }}</th>
                                            {% endfor %}
                                            {% if table == 'person' or table == 'debt' %}
                                                <th>Actions</th>
                                            {% endif %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in all_data[table] %}
                                    <tr>
                                        {% for col, value in row.items() %}
                                            <td>
                                                {% if col == 'status' %}
                                                    {% if value %}Paid{% else %}Unpaid{% endif %}
                                                {% else %}
                                                    {{ value if value is not none else '-' }}
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                        {% if table == 'person' %}
                                            <td>
                                                <button type="button" class="btn btn-sm btn-warning edit-person-btn" data-person-id="{{ row.id }}" data-person-name="{{ row.name }}">Edit</button>
                                                <form method="POST" action="{{ url_for('delete_person', person_id=row.id) }}" style="display:inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this person?')">Delete</button>
                                                </form>
                                            </td>
                                        {% elif table == 'debt' %}
                                            <td>
                                                <button type="button" class="btn btn-sm btn-warning edit-debt-btn" data-debt-id="{{ row.id }}" data-borrower-id="{{ row.name_id }}" data-lender-id="{{ row.lender_id }}" data-amount="{{ row.amount }}" data-reason="{{ row.reason }}" data-status="{{ row.status }}">Edit</button>
                                                <form method="POST" action="{{ url_for('delete_debt', debt_id=row.id) }}" style="display:inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this debt?')">Delete</button>
                                                </form>
                                            </td>
                                        {% endif %}
                                    </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <p class="no-data">{{ all_data[table].get('error', 'No data available') if all_data[table] is mapping else 'No data available' }}</p>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Add Person Modal -->
    <div class="modal fade" id="addPersonModal" tabindex="-1" aria-labelledby="addPersonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPersonModalLabel">Add Person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('add_person') }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Person</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Person Modal -->
    <div class="modal fade" id="editPersonModal" tabindex="-1" aria-labelledby="editPersonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPersonModalLabel">Edit Person</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" id="editPersonForm">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Person</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div class="modal fade" id="addDebtModal" tabindex="-1" aria-labelledby="addDebtModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addDebtModalLabel">Add Debt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('add_debt') }}">
                        <div class="mb-3">
                            <label for="borrower" class="form-label">Borrower</label>
                            <select class="form-control" id="borrower" name="borrower" required>
                                <option value="">Select Borrower</option>
                                {% for person in all_data.get('person', []) %}
                                    <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="lender" class="form-label">Lender</label>
                            <select class="form-control" id="lender" name="lender" required>
                                <option value="">Select Lender</option>
                                {% for person in all_data.get('person', []) %}
                                    <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" id="amount" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="reason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="reason" name="reason" required>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-control" id="status" name="status" required>
                                <option value="0">Unpaid</option>
                                <option value="1">Paid</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Debt</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Debt Modal -->
    <div class="modal fade" id="editDebtModal" tabindex="-1" aria-labelledby="editDebtModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editDebtModalLabel">Edit Debt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" id="editDebtForm">
                        <div class="mb-3">
                            <label for="editBorrower" class="form-label">Borrower</label>
                            <select class="form-control" id="editBorrower" name="borrower" required>
                                <option value="">Select Borrower</option>
                                {% for person in all_data.get('person', []) %}
                                    <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editLender" class="form-label">Lender</label>
                            <select class="form-control" id="editLender" name="lender" required>
                                <option value="">Select Lender</option>
                                {% for person in all_data.get('person', []) %}
                                    <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editAmount" class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" id="editAmount" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="editReason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="editReason" name="reason" required>
                        </div>
                        <div class="mb-3">
                            <label for="editStatus" class="form-label">Status</label>
                            <select class="form-control" id="editStatus" name="status" required>
                                <option value="0">Unpaid</option>
                                <option value="1">Paid</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Debt</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Split Debt Modal -->
    <div class="modal fade" id="splitDebtModal" tabindex="-1" aria-labelledby="splitDebtModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="splitDebtModalLabel">Split Debt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('split_debt') }}">
                        <div class="mb-3">
                            <label for="splitLender" class="form-label">Lender Name</label>
                            <select class="form-control" id="splitLender" name="lender" required>
                                <option value="">Select Lender</option>
                                {% for person in all_data.get('person', []) %}
                                    <option value="{{ person.id }}">{{ person.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="splitAmount" class="form-label">Total Amount</label>
                            <input type="number" step="0.01" class="form-control" id="splitAmount" name="amount" required>
                        </div>
                        <div class="mb-3">
                            <label for="splitReason" class="form-label">Reason</label>
                            <input type="text" class="form-control" id="splitReason" name="reason" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Select People to Split With</label>
                            <div class="row">
                                {% for person in all_data.get('person', []) %}
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="{{ person.name }}" id="splitPerson{{ person.id }}" name="split_names">
                                            <label class="form-check-label" for="splitPerson{{ person.id }}">
                                                {{ person.name }}
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Split Debt</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- View All Unpaid Debts Modal -->
    <div class="modal fade" id="viewAllModal" tabindex="-1" aria-labelledby="viewAllModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewAllModalLabel">Unpaid Debts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="unpaidDebtsContent">
                        <!-- Content will be loaded here via AJAX -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload to GitHub Modal -->
    <div class="modal fade" id="uploadToGitHubModal" tabindex="-1" aria-labelledby="uploadToGitHubModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadToGitHubModalLabel">Upload Database to GitHub</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('upload_to_github') }}">
                        <div class="mb-3">
                            <label for="githubToken" class="form-label">GitHub Personal Access Token</label>
                            <input type="password" class="form-control" id="githubToken" name="github_token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" required>
                            <div class="form-text">You can create a token at <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings</a> (needs 'repo' scope)</div>
                        </div>
                        <div class="mb-3">
                            <label for="commitMessage" class="form-label">Commit Message</label>
                            <input type="text" class="form-control" id="commitMessage" name="commit_message" value="Update database" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Handle edit person button clicks
        document.querySelectorAll('.edit-person-btn').forEach(button => {
            button.addEventListener('click', function() {
                const personId = this.getAttribute('data-person-id');
                const personName = this.getAttribute('data-person-name');
                document.getElementById('editName').value = personName;
                document.getElementById('editPersonForm').action = `/edit_person/${personId}`;
                new bootstrap.Modal(document.getElementById('editPersonModal')).show();
            });
        });

        // Handle edit debt button clicks
        document.querySelectorAll('.edit-debt-btn').forEach(button => {
            button.addEventListener('click', function() {
                const debtId = this.getAttribute('data-debt-id');
                const borrowerId = this.getAttribute('data-borrower-id');
                const lenderId = this.getAttribute('data-lender-id');
                const amount = this.getAttribute('data-amount');
                const reason = this.getAttribute('data-reason');
                const status = this.getAttribute('data-status');
                document.getElementById('editBorrower').value = borrowerId;
                document.getElementById('editLender').value = lenderId;
                document.getElementById('editAmount').value = amount;
                document.getElementById('editReason').value = reason;
                document.getElementById('editStatus').value = status;
                document.getElementById('editDebtForm').action = `/edit_debt/${debtId}`;
                new bootstrap.Modal(document.getElementById('editDebtModal')).show();
            });
        });

        // Handle view all button clicks
        document.querySelectorAll('.view-all-btn').forEach(button => {
            button.addEventListener('click', function() {
                const borrowerId = this.getAttribute('data-borrower-id');
                const lenderId = this.getAttribute('data-lender-id');
                const borrowerName = this.getAttribute('data-borrower-name');
                const lenderName = this.getAttribute('data-lender-name');

                // Update modal title
                document.getElementById('viewAllModalLabel').textContent = `Unpaid Debts: ${borrowerName} owes ${lenderName}`;

                // Fetch unpaid debts data
                fetch(`/unpaid_details/${borrowerId}/${lenderId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('unpaidDebtsContent').innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error fetching unpaid debts:', error);
                        document.getElementById('unpaidDebtsContent').innerHTML = '<p class="text-danger">Error loading data.</p>';
                    });

                // Show modal
                new bootstrap.Modal(document.getElementById('viewAllModal')).show();
            });
        });
    </script>
</body>
</html>
